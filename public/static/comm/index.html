<html>

<head>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/global/style.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" text="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script text="text/javascript">
    setInterval(function(){
      console.log("Reading Progress");

    }, 2000);
  </script>
  <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />

  <!-- Add this after vue.js -->
  <script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
  <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body style="font-size: 200%">
  <br>
  <div class="container" id="app">
    <form onSubmit="return false;" enctype="multipart/form-data">
      <div class="form-group" align="center">
        <h4 class="header-gradient">Upload Usage Reports Here</h4><br />
        <div class="large-12 medium-12 small-12 cell">
          <b-form-file v-model="files" ref="files" class="mt3" multiple plain></b-form-file><br />
          <button v-on:click="submitFile()">Submit</button>
        </div>
        <div v-if="files" class="large-12 medium-12 small-12 cell" v-for="file in files">
          <h3>{{file.name}}</h3>
        </div>
      </div>
    </form>
    <div class="console"></div>
    <button v-on:click="reportBug()" class="btn btn-danger btn-block">Report Error</button>
  </div>
</body>

</html>

<script>
  var app = new Vue({
    el: '#app',
    data: {
      files: [],
      id: ''
    },
    mounted: function() {
      this.id = this.makeid();
      setInterval(function() {
        jQuery.get('http://' + window.location.host + '/comm/progress/progress_' + this.id + '.txt', function(data) {
          if (data != $(".console").text()) {
            $(".console").html(data);
            $('.console').animate({
              scrollTop: $('.console').get(0).scrollHeight
            });
          } else {
            console.log(data);
            console.log($(".console").text());
          }
        });
      }.bind(this), 2000);
    },

    methods: {
      onFileChange() {
        this.files = this.$refs.files.files;
      },
      reportBug() {
        let formData = new FormData();
        formData.append("id", this.id);
        axios.post('/commvault/bug', formData).then(function() {
          console.log("Bug Submitted");
          alert("Error reported");
        });
      },
      makeid() {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        for (var i = 0; i < 10; i++)
          text += possible.charAt(Math.floor(Math.random() * possible.length));
        return text;
      },
      submitFile() {
        let formData = new FormData();
        for (var i = 0; i < this.files.length; i++) {
          let file = this.files[i];
          formData.append('files[' + i + ']', file);
        }
        formData.append("id", this.id);
        axios.post('/commvault',
            formData, {
              headers: {
                'Content-Type': 'multipart/form-data'
              }
            }
          ).then(function() {
            console.log('SUCCESS!!');
          })
          .catch(function() {
            console.log('FAILURE!!');
          });
      }
    }
  })
</script>